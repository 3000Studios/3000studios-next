---
name: Revenue Lock Guard

'on':
  pull_request:
    branches: [main]

jobs:
  revenue-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Protect ads.txt
        run: |
          git fetch origin main
          if git diff --name-only origin/main...HEAD | grep -q "ads.txt"; then
            echo "❌ ads.txt is protected and cannot be modified"
            exit 1
          fi

      - name: Protect Stripe Environment Usage
        run: |
          STRIPE_VARS="STRIPE_SECRET|STRIPE_3000_SECRET|NEXT_PUBLIC_STRIPE"
          if git diff origin/main...HEAD | grep -iE "$STRIPE_VARS"; then
            echo "❌ Stripe environment variables modified"
            exit 1
          fi

      - name: Protect AdSense CMP Logic
        run: |
          AD_PATTERNS="consent|adsense|cmp|iab"
          if git diff origin/main...HEAD | grep -iE "$AD_PATTERNS"; then
            echo "⚠️ Ad/Consent logic touched — manual review required"
            exit 1
          fi

      - name: Revenue Lock Passed
        run: echo "✅ Revenue systems intact"
