name: Revenue Lock

on: [pull_request]

jobs:
  revenue-lock:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Protect revenue files
        run: |
          # Get list of changed files
          changed_files=$(git diff --name-only origin/main...HEAD 2>/dev/null || echo "")
          
          # Exit early if no files changed
          if [ -z "$changed_files" ]; then
            echo "✅ No files changed - Revenue lock passed"
            exit 0
          fi
          
          # Define protected patterns
          protected=(
            "public/ads.txt"
            "src/app/api/stripe/"
            "src/lib/stripe/"
            "src/components/AdSense.tsx"
            "src/app/components/GoogleAdsPlaceholder.tsx"
          )
          
          violations=()
          
          # Check each changed file against protected patterns
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            for pattern in "${protected[@]}"; do
              # Check if file matches pattern exactly or starts with pattern (for directories)
              if [[ "$file" == "$pattern" ]] || [[ "$pattern" == */ && "$file" == "${pattern%/}/"* ]]; then
                violations+=("$file")
                break
              fi
            done
          done <<< "$changed_files"
          
          if [ ${#violations[@]} -gt 0 ]; then
            echo "❌ Revenue-protected files modified:"
            for v in "${violations[@]}"; do
              echo "   - $v"
            done
            exit 1
          fi
          
          echo "✅ Revenue lock passed"
