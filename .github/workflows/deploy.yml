name: üöÄ 3KAI Auto Deploy + Sync

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: vercel-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚ö° Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: üß† Determine environment
        id: vars
        shell: bash
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            echo "env=preview" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi

      - name: üß± Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Type check
        run: npm run type-check --silent

      - name: üßπ Lint
        run: npm run lint --silent || true

      - name: üèóÔ∏è Build project
        run: npm run build --silent

      - name: ‚öôÔ∏è Install Vercel CLI
        run: npm i -g vercel@latest

      - name: üîë Pull Vercel environment (${{ steps.vars.outputs.env }})
        run: vercel pull --yes --environment=${{ steps.vars.outputs.env }} --token "$VERCEL_TOKEN"

      - name: üè∑Ô∏è Generate version tag
        id: tag
        run: |
          VERSION_TAG="v$(date +'%Y.%m.%d-%H%M')"
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "üì¶ Version tag: $VERSION_TAG"

      - name: üöÄ Deploy (prebuilt)
        id: vercel
        shell: bash
        run: |
          if [ "${{ steps.vars.outputs.is_production }}" = "true" ]; then
            echo "üåê Deploying production build..."
            url=$(vercel deploy --prebuilt --prod --yes --token "$VERCEL_TOKEN")
          else
            echo "üß™ Deploying preview build..."
            url=$(vercel deploy --prebuilt --yes --token "$VERCEL_TOKEN")
          fi
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "üåç Deployment URL: $url"

      - name: üí¨ Comment deployment URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.vercel.outputs.url }}';
            const isProd = ${{ steps.vars.outputs.is_production }};
            const commentBody = `üöÄ **Vercel ${isProd ? 'Production' : 'Preview'} Deployment** (${new Date().toLocaleString()}):\n\nüîó [View Deployment](${url})`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: üîî 3KAI Deploy Hook Trigger (backup)
        if: ${{ steps.vars.outputs.is_production == 'true' }}
        run: |
          echo "Triggering 3KAI deploy hook..."
          curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_vaQtOh2emuK0ZsMzCEQJUHd1EezI/VW8QBhCTgL
          echo "‚úÖ 3KAI deploy hook triggered successfully."

      - name: ‚úÖ Success notification
        if: success()
        run: echo "üéâ Deployment ($VERSION_TAG) succeeded!"

      - name: ‚ùå Failure alert
        if: failure()
        run: |
          echo "‚ö†Ô∏è Deployment failed at $(date)."
          # Optional Slack alert
          # curl -X POST -H 'Content-type: application/json' \
          # --data "{\"text\":\"üö® 3KAI Deploy Failed: ${GITHUB_REPOSITORY} (${GITHUB_SHA})\"}" \
          # ${{ secrets.SLACK_WEBHOOK_URL }}

  auto-sync:
    name: üîÑ Auto Commit & Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply 3KAI Changes
        run: |
          echo "üß† Applying automatic code updates..."
          echo "<!-- Auto update $(date) -->" >> public/_3kai.log

      - name: Commit and Push
        run: |
          git config user.name "3KAI Autodeploy"
          git config user.email "ops@3000studios.com"
          git add -A
          git commit -m "ü§ñ 3KAI auto-sync update $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin HEAD:${GITHUB_REF#refs/heads/}

      - name: Trigger Deploy Hook
        run: |
          curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_vaQtOh2emuK0ZsMzCEQJUHd1EezI/VW8QBhCTgL
          echo "‚úÖ Sync deploy triggered."
