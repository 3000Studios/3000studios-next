name: ğŸš€ 3KAI Deploy to Vercel (Auto)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: vercel-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš¡ Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ğŸ§  Determine environment
        id: vars
        shell: bash
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "env=production" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            echo "env=preview" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§± Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies (clean)
        run: npm ci

      - name: ğŸ” Type check
        run: npm run type-check --silent

      - name: ğŸ§¹ Lint
        run: npm run lint --silent || true

      - name: ğŸ—ï¸ Build project
        run: npm run build --silent

      - name: âš™ï¸ Install Vercel CLI
        run: npm i -g vercel@latest

      - name: ğŸ”‘ Pull Vercel environment (${{ steps.vars.outputs.env }})
        run: vercel pull --yes --environment=${{ steps.vars.outputs.env }} --token "$VERCEL_TOKEN"

      - name: ğŸ·ï¸ Generate version tag
        id: tag
        run: |
          VERSION_TAG="v$(date +'%Y.%m.%d-%H%M')"
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "ğŸ“¦ Version tag: $VERSION_TAG"

      - name: ğŸš€ Deploy (prebuilt)
        id: vercel
        shell: bash
        run: |
          if [ "${{ steps.vars.outputs.is_production }}" = "true" ]; then
            echo "ğŸŒ Deploying production build..."
            url=$(vercel deploy --prebuilt --prod --yes --token "$VERCEL_TOKEN")
          else
            echo "ğŸ§ª Deploying preview build..."
            url=$(vercel deploy --prebuilt --yes --token "$VERCEL_TOKEN")
          fi
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "ğŸŒ Deployment URL: $url"

      - name: ğŸ’¬ Comment deployment URL on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.vercel.outputs.url }}';
            const isProd = ${{ steps.vars.outputs.is_production }};
            const commentBody = `ğŸš€ **Vercel ${isProd ? 'Production' : 'Preview'} Deployment** (${new Date().toLocaleString()}):\n\nğŸ”— [View Deployment](${url})`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: ğŸ”” 3KAI Deploy Hook Trigger (optional backup)
        if: ${{ steps.vars.outputs.is_production == 'true' }}
        run: |
          echo "Triggering 3KAI deploy hook..."
          curl -X POST https://api.vercel.com/v1/integrations/deploy/prj_vaQtOh2emuK0ZsMzCEQJUHd1EezI/VW8QBhCTgL
          echo "âœ… 3KAI deploy hook triggered successfully."

      - name: âœ… Success notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment ($VERSION_TAG) succeeded!"

      - name: âŒ Failure alert
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed at $(date)."
          # Optional: Slack alert (requires SLACK_WEBHOOK_URL secret)
          # curl -X POST -H 'Content-type: application/json' \
          # --data "{\"text\":\"ğŸš¨ 3KAI Deploy Failed: ${GITHUB_REPOSITORY} (${GITHUB_SHA})\"}" \
          # ${{ secrets.SLACK_WEBHOOK_URL }}