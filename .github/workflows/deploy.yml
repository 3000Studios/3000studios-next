name: âš¡ 3KAI Instant Deploy + Auto Rollback

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: "3kai-deploy"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: âš™ï¸ Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: âš¡ Ultra-fast install (clean + cache)
        run: npm ci --prefer-offline --no-audit --progress=false

      - name: ğŸ§± Build project
        run: npm run build --silent || true

      - name: âš™ï¸ Install Vercel CLI
        run: npm i -g vercel@latest

      - name: ğŸ·ï¸ Generate version tag
        id: tag
        run: |
          VERSION_TAG="v$(date +'%Y.%m.%d-%H%M')"
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "ğŸ“¦ Version tag: $VERSION_TAG"

      - name: ğŸš€ Deploy to Vercel (Production)
        id: vercel
        continue-on-error: true
        run: |
          echo "ğŸŒ Deploying production build..."
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --yes --token "$VERCEL_TOKEN" 2>&1) || true
          echo "$DEPLOY_URL"
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: âœ… Check deploy status
        id: deploy_status
        run: |
          if [[ "${{ steps.vercel.outcome }}" == "success" ]]; then
            echo "success=true" >> $GITHUB_ENV
          else
            echo "success=false" >> $GITHUB_ENV
          fi

      - name: ğŸ” Auto-rollback on failure
        if: env.success == 'false'
        run: |
          echo "âŒ Deployment failed. Rolling back..."
          PREV_DEPLOY=$(vercel ls --token "$VERCEL_TOKEN" | grep production | head -n 1 | awk '{print $2}')
          if [ -n "$PREV_DEPLOY" ]; then
            vercel rollback "$PREV_DEPLOY" --token "$VERCEL_TOKEN"
            echo "âœ… Rolled back to previous stable deployment: $PREV_DEPLOY"
          else
            echo "âš ï¸ No previous deployment found to roll back to."
          fi

      - name: ğŸ”” Trigger 3KAI Deploy Hook (fast redeploy)
        if: env.success == 'true'
        run: |
          curl -s -X POST "$VERCEL_DEPLOY_HOOK" > /dev/null
          echo "âœ… 3KAI deploy hook triggered."

      - name: âœ… Success log
        if: env.success == 'true'
        run: echo "ğŸ‰ Deployment ($VERSION_TAG) succeeded!"

      - name: âŒ Failure alert
        if: env.success == 'false'
        run: |
          echo "âš ï¸ Deployment failed at $(date)."
          # Optional: Slack alert
          # curl -X POST -H 'Content-type: application/json' \
          # --data "{\"text\":\"ğŸš¨ 3KAI Deploy Failed: ${GITHUB_REPOSITORY} (${GITHUB_SHA})\"}" \
          # ${{ secrets.SLACK_WEBHOOK_URL }}

  auto-sync:
    name: ğŸ”„ Auto Commit & Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply 3KAI Changes
        run: |
          echo "ğŸ§  Applying automatic code updates..."
          echo "<!-- Auto update $(date) -->" >> public/_3kai.log

      - name: Commit and Push
        run: |
          git config user.name "3KAI Autodeploy"
          git config user.email "ops@3000studios.com"
          git add -A
          git commit -m "ğŸ¤– 3KAI auto-sync update $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin HEAD:${GITHUB_REF#refs/heads/}

      - name: Trigger Deploy Hook
        run: |
          curl -s -X POST "$VERCEL_DEPLOY_HOOK" > /dev/null
          echo "âœ… Sync deploy triggered."
