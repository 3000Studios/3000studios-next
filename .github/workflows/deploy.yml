name: âš¡ 3KAI Ultra-Fast Parallel Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: "3kai-deploy"
  cancel-in-progress: true

jobs:
  build:
    name: Parallel builds
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: [app, assets, types]
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci --prefer-offline --no-audit --progress=false
      - name: Run ${{ matrix.task }} build
        run: |
          if [ "${{ matrix.task }}" = "app" ]; then
            npm run build
          elif [ "${{ matrix.task }}" = "assets" ]; then
            npm run build:assets || true
          elif [ "${{ matrix.task }}" = "types" ]; then
            npm run type-check || true
          fi
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.task }}
          path: .next

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/download-artifact@v4
        with:
          name: build-app
          path: .next
      - run: npm i -g vercel@latest
      - name: Deploy & Rollback on failure
        id: deploy
        shell: bash
        run: |
          echo "ðŸŒ Deploying production build..."
          set +e
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --yes --token "$VERCEL_TOKEN")
          STATUS=$?
          set -e
          if [ $STATUS -ne 0 ]; then
            echo "âŒ Deployment failed. Rolling back..."
            PREV_DEPLOY=$(vercel ls --token "$VERCEL_TOKEN" | grep production | head -n 1 | awk '{print $2}')
            if [ -n "$PREV_DEPLOY" ]; then
              vercel rollback "$PREV_DEPLOY" --token "$VERCEL_TOKEN"
              echo "âœ… Rolled back to $PREV_DEPLOY"
            fi
            exit 1
          fi
          echo "âœ… Deployment succeeded: $DEPLOY_URL"
      - run: curl -s -X POST "$VERCEL_DEPLOY_HOOK" > /dev/null

  auto-sync:
    name: Auto Commit & Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "<!-- Auto update $(date) -->" >> public/_3kai.log
          git config user.name "3KAI Autodeploy"
          git config user.email "ops@3000studios.com"
          git add -A
          git commit -m "ðŸ¤– 3KAI auto-sync update $(date +'%Y-%m-%d %H:%M:%S')" || true
          git push origin HEAD:${GITHUB_REF#refs/heads/}
      - run: curl -s -X POST "$VERCEL_DEPLOY_HOOK" > /dev/null
