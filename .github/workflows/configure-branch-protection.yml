name: Configure Branch Protection

on:
  workflow_dispatch: # Allow manual trigger
    inputs:
      dry_run:
        description: 'Dry run (show what would be applied without applying)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - '.github/branch-protection-config.yml'
      - '.github/workflows/configure-branch-protection.yml'
      - 'scripts/configure-branch-protection.mjs'

permissions:
  contents: read
  # Note: Branch protection requires admin access
  # This workflow needs to be triggered with a token that has admin permissions

jobs:
  configure-protection:
    name: Apply Branch Protection Rules
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install @octokit/rest@^22.0.1 yaml@^2.6.1
      
      - name: Display current configuration
        run: |
          echo "## Branch Protection Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration File" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          cat .github/branch-protection-config.yml >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      - name: Apply branch protection rules
        if: ${{ !inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/configure-branch-protection.mjs
      
      - name: Dry run - show what would be applied
        if: ${{ inputs.dry_run }}
        run: |
          echo "ðŸ” DRY RUN MODE - No changes will be applied"
          echo ""
          echo "The following configuration would be applied:"
          cat .github/branch-protection-config.yml
          echo ""
          echo "To apply these changes, re-run without dry_run or push changes to main branch"
      
      - name: Verify configuration
        if: ${{ !inputs.dry_run }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/verify-branch-protection.mjs
      
      - name: Summary
        if: always() && !inputs.dry_run
        run: |
          echo "### Configuration Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Branch protection rules have been applied to the main branch." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Protection Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pull request required before merging" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Minimum 1 approval required" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dismiss stale approvals on new commits" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Required status checks (build, lint, type-check)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branches must be up-to-date before merging" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Linear history required" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Force pushes blocked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branch deletions blocked" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify protection status: \`npm run verify-branch-protection\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Test by attempting direct push to main (should fail)" >> $GITHUB_STEP_SUMMARY
          echo "3. Use PR workflow for all future changes" >> $GITHUB_STEP_SUMMARY
